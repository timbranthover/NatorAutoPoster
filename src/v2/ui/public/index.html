<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nator V2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:            #0a0b0d;
      --surface:       #13151a;
      --surface-hi:    #1a1d25;
      --border:        #252830;
      --border-subtle: #1c1f27;
      --accent:        #7c3aed;
      --accent-hi:     #9461ff;
      --accent-glow:   rgba(124,58,237,.18);
      --accent-ring:   rgba(124,58,237,.35);
      --text:          #dde1ed;
      --text-2:        #7e8799;
      --text-3:        #40475a;
      --success:       #22c55e;
      --success-bg:    rgba(34,197,94,.1);
      --danger:        #ef4444;
      --danger-bg:     rgba(239,68,68,.1);
      --warn:          #f59e0b;
      --warn-bg:       rgba(245,158,11,.1);
      --font:          'DM Sans', system-ui, sans-serif;
      --mono:          'JetBrains Mono', ui-monospace, monospace;
      --radius:        8px;
      --radius-sm:     5px;
      --sidebar-w:     204px;
      --transition:    .15s ease;
    }

    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font); font-size: 14px; line-height: 1.5; }

    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }

    .shell { display: flex; height: 100vh; overflow: hidden; }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar {
      width: var(--sidebar-w); flex-shrink: 0;
      background: var(--surface); border-right: 1px solid var(--border-subtle);
      display: flex; flex-direction: column;
    }
    .sb-logo {
      padding: 20px 18px 18px; border-bottom: 1px solid var(--border-subtle);
      display: flex; align-items: center; gap: 10px;
    }
    .sb-logo-mark {
      width: 28px; height: 28px; background: var(--accent); border-radius: 7px;
      display: flex; align-items: center; justify-content: center;
      font-family: var(--mono); font-size: 12px; font-weight: 500; color: #fff;
      box-shadow: 0 0 14px var(--accent-glow); flex-shrink: 0;
    }
    .sb-logo-text { font-family: var(--mono); font-size: 15px; font-weight: 500; letter-spacing: -.3px; }
    .sb-logo-text span {
      font-size: 10px; background: var(--surface-hi); border: 1px solid var(--border);
      color: var(--text-2); padding: 1px 5px; border-radius: 4px;
      vertical-align: middle; margin-left: 4px; font-weight: 400;
    }
    .sb-nav { flex: 1; padding: 10px 8px; display: flex; flex-direction: column; gap: 2px; overflow-y: auto; }
    .nav-item {
      display: flex; align-items: center; gap: 9px; padding: 8px 10px;
      border-radius: var(--radius-sm); cursor: pointer; color: var(--text-2);
      font-size: 13px; font-weight: 500;
      transition: color var(--transition), background var(--transition);
      user-select: none;
    }
    .nav-item:hover { background: var(--surface-hi); color: var(--text); }
    .nav-item.active { background: var(--accent-glow); color: var(--text); }
    .nav-item.active .nav-icon { color: var(--accent-hi); }
    .nav-icon { width: 15px; height: 15px; flex-shrink: 0; }
    .sb-footer { padding: 14px 18px; border-top: 1px solid var(--border-subtle); }
    .mode-chip {
      display: inline-flex; align-items: center; gap: 5px;
      font-family: var(--mono); font-size: 10px; font-weight: 500;
      padding: 3px 8px; border-radius: 99px; letter-spacing: .5px;
    }
    .mode-chip.dry  { background: var(--warn-bg);    color: var(--warn);    border: 1px solid rgba(245,158,11,.2); }
    .mode-chip.live { background: var(--success-bg); color: var(--success); border: 1px solid rgba(34,197,94,.2);  }
    .mode-chip::before { content: ''; width: 5px; height: 5px; border-radius: 50%; background: currentColor; }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    .main { flex: 1; overflow-y: auto; }
    .view { display: none; padding: 28px 30px; min-height: 100%; }
    .view.active { display: block; }
    .view-header { margin-bottom: 24px; }
    .view-title { font-size: 20px; font-weight: 600; letter-spacing: -.3px; }
    .view-sub { font-size: 13px; color: var(--text-2); margin-top: 2px; }
    .view-header-row { display: flex; align-items: flex-start; justify-content: space-between; }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card { background: var(--surface); border: 1px solid var(--border-subtle); border-radius: var(--radius); overflow: hidden; }
    .card-head { padding: 14px 18px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; }
    .card-title { font-size: 13px; font-weight: 600; }
    .card-sub { font-size: 11px; color: var(--text-3); margin-top: 2px; }
    .card-body { padding: 18px; }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      padding: 7px 14px; border-radius: var(--radius-sm);
      font-family: var(--font); font-size: 13px; font-weight: 500;
      cursor: pointer; border: none; transition: all var(--transition);
      white-space: nowrap;
    }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--accent-hi); box-shadow: 0 0 20px var(--accent-glow); }
    .btn-primary:active:not(:disabled) { transform: scale(.98); }
    .btn-ghost { background: transparent; color: var(--text-2); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--surface-hi); color: var(--text); }
    .btn-danger { background: var(--danger-bg); color: var(--danger); border: 1px solid rgba(239,68,68,.2); }
    .btn-danger:hover { background: var(--danger); color: #fff; }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    .btn-full { width: 100%; }

    /* ‚îÄ‚îÄ Forms ‚îÄ‚îÄ */
    .field { margin-bottom: 16px; }
    .field:last-child { margin-bottom: 0; }
    label.lbl { display: block; font-size: 12px; font-weight: 500; color: var(--text-2); margin-bottom: 6px; letter-spacing: .2px; }
    select, textarea, input[type="text"], input[type="number"] {
      width: 100%; background: var(--bg); border: 1px solid var(--border);
      border-radius: var(--radius-sm); color: var(--text); font-family: var(--font);
      font-size: 13px; padding: 8px 12px; outline: none;
      transition: border-color var(--transition), box-shadow var(--transition); appearance: none;
    }
    select:focus, textarea:focus, input[type="text"]:focus, input[type="number"]:focus {
      border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow);
    }
    textarea { resize: vertical; line-height: 1.65; font-family: var(--mono); font-size: 12.5px; }
    select {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%234d5468'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 12px center; padding-right: 30px;
    }

    /* ‚îÄ‚îÄ Stats bar ‚îÄ‚îÄ */
    .stats-bar {
      display: flex; flex-wrap: wrap; gap: 0; font-size: 11.5px; color: var(--text-3);
      margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border-subtle);
    }
    .stat-item { display: flex; align-items: center; gap: 4px; }
    .stat-item + .stat-item::before { content: '¬∑'; margin: 0 8px; }
    .stat-val { color: var(--text-2); font-weight: 500; }

    /* ‚îÄ‚îÄ Pipeline view ‚îÄ‚îÄ */
    .pipeline-grid { display: grid; grid-template-columns: 360px 1fr; gap: 20px; align-items: start; }

    /* ‚îÄ‚îÄ Stepper ‚îÄ‚îÄ */
    .active-job-card { margin-bottom: 20px; }
    .active-job-card.hidden { display: none; }
    .stepper { display: flex; align-items: flex-start; padding: 4px 0; }
    .step { display: flex; flex-direction: column; align-items: center; flex: 1; position: relative; }
    .step:not(:last-child)::after {
      content: ''; position: absolute; top: 9px; left: calc(50% + 10px);
      width: calc(100% - 20px); height: 1px; background: var(--border); transition: background .4s;
    }
    .step.done::after  { background: var(--success); }
    .step.active::after { background: linear-gradient(90deg, var(--accent), var(--border)); }
    .step-dot {
      width: 18px; height: 18px; border-radius: 50%; background: var(--border);
      border: 2px solid var(--border); display: flex; align-items: center; justify-content: center;
      font-size: 9px; color: var(--text-3); position: relative; z-index: 1; transition: all .3s;
    }
    .step.done .step-dot   { background: var(--success); border-color: var(--success); color: #fff; font-size: 10px; }
    .step.active .step-dot {
      background: var(--accent); border-color: var(--accent-hi); color: #fff;
      box-shadow: 0 0 0 4px var(--accent-glow), 0 0 12px var(--accent-glow);
      animation: pulse-ring 1.6s ease infinite;
    }
    @keyframes pulse-ring {
      0%   { box-shadow: 0 0 0 0   var(--accent-ring), 0 0  8px var(--accent-glow); }
      50%  { box-shadow: 0 0 0 6px rgba(124,58,237,0), 0 0 18px var(--accent-glow); }
      100% { box-shadow: 0 0 0 0   var(--accent-ring), 0 0  8px var(--accent-glow); }
    }
    .step-label { font-size: 10px; font-weight: 500; color: var(--text-3); margin-top: 6px; letter-spacing: .3px; text-transform: uppercase; }
    .step.done  .step-label  { color: var(--success); }
    .step.active .step-label { color: var(--accent-hi); }

    /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; font-size: 11px; font-weight: 600; color: var(--text-3); letter-spacing: .5px; text-transform: uppercase; padding: 0 14px 10px; white-space: nowrap; }
    td { padding: 10px 14px; border-top: 1px solid var(--border-subtle); font-size: 13px; vertical-align: middle; }
    tr { cursor: pointer; transition: background var(--transition); }
    tr:hover td { background: var(--surface-hi); }
    .tbody-empty td { color: var(--text-3); font-size: 13px; padding: 28px 14px; cursor: default; }
    tr.tbody-empty:hover td { background: transparent; }
    .table-footer { padding: 10px 18px; border-top: 1px solid var(--border-subtle); }
    .table-footer a { font-size: 12px; color: var(--accent-hi); text-decoration: none; cursor: pointer; }
    .table-footer a:hover { text-decoration: underline; }

    /* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
    .badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 2px 8px; border-radius: 99px;
      font-size: 11px; font-weight: 500; white-space: nowrap; text-transform: uppercase; letter-spacing: .3px;
    }
    .badge::before { content: ''; width: 5px; height: 5px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
    .badge-pending   { background: rgba(100,116,139,.12); color: #64748b; }
    .badge-available { background: var(--success-bg); color: var(--success); }
    .badge-used      { background: rgba(100,116,139,.12); color: #64748b; }
    .badge-scripting,.badge-tts,.badge-rendering,.badge-uploading,.badge-publishing {
      background: var(--accent-glow); color: var(--accent-hi); animation: badge-pulse 2s ease infinite;
    }
    @keyframes badge-pulse { 0%,100%{opacity:1} 50%{opacity:.65} }
    .badge-done   { background: var(--success-bg); color: var(--success); }
    .badge-failed { background: var(--danger-bg);  color: var(--danger);  }

    /* ‚îÄ‚îÄ Clips view ‚îÄ‚îÄ */
    .dropzone {
      border: 1.5px dashed var(--border); border-radius: var(--radius);
      padding: 36px 24px; text-align: center; cursor: pointer; margin-bottom: 24px;
      transition: border-color var(--transition), background var(--transition);
    }
    .dropzone:hover, .dropzone.drag-over { border-color: var(--accent); background: var(--accent-glow); }
    .dz-icon { font-size: 28px; margin-bottom: 10px; opacity: .45; }
    .dz-text { font-size: 14px; color: var(--text-2); font-weight: 500; }
    .dz-hint { font-size: 12px; color: var(--text-3); margin-top: 4px; }
    .clips-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 14px; }
    .clip-card {
      background: var(--surface); border: 1px solid var(--border-subtle); border-radius: var(--radius);
      overflow: hidden; cursor: pointer; transition: border-color var(--transition), box-shadow var(--transition);
    }
    .clip-card:hover    { border-color: var(--border); box-shadow: 0 2px 12px rgba(0,0,0,.3); }
    .clip-card.expanded { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
    .clip-card video    { width: 100%; display: block; background: #000; max-height: 180px; object-fit: contain; }
    .clip-card-body     { padding: 12px 14px; }
    .clip-name  { font-family: var(--mono); font-size: 11.5px; margin-bottom: 6px; word-break: break-all; line-height: 1.4; }
    .clip-meta  { display: flex; align-items: center; justify-content: space-between; }
    .clip-size  { font-size: 11px; color: var(--text-3); }
    .clips-empty { text-align: center; padding: 40px 20px; color: var(--text-3); grid-column: 1/-1; }
    .clips-empty-icon { font-size: 32px; margin-bottom: 8px; opacity: .35; }

    /* ‚îÄ‚îÄ Filter tabs ‚îÄ‚îÄ */
    .filter-tabs { display: flex; gap: 4px; margin-bottom: 18px; }
    .tab { padding: 5px 14px; border-radius: 99px; font-size: 12px; font-weight: 500; cursor: pointer; border: 1px solid transparent; color: var(--text-2); transition: all var(--transition); }
    .tab:hover  { color: var(--text); background: var(--surface-hi); }
    .tab.active { background: var(--accent-glow); color: var(--accent-hi); border-color: var(--accent-ring); }

    /* ‚îÄ‚îÄ Settings view ‚îÄ‚îÄ */
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .provider-row { padding: 12px 0; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .provider-row:last-child { border-bottom: none; }
    .provider-type { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; color: var(--text-3); flex-shrink: 0; }
    .provider-pills { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .provider-pill {
      padding: 3px 10px; border-radius: 99px; font-size: 11.5px; font-family: var(--mono);
      cursor: pointer; border: 1px solid var(--border); color: var(--text-2); transition: all var(--transition);
    }
    .provider-pill:hover  { border-color: var(--text-3); color: var(--text); }
    .provider-pill.active { background: var(--accent-glow); color: var(--accent-hi); border-color: var(--accent-ring); }
    .config-row { padding: 14px 0; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; gap: 16px; }
    .config-row:last-child { border-bottom: none; }
    .config-label { font-size: 13px; font-weight: 500; }
    .config-key   { font-family: var(--mono); font-size: 10px; color: var(--text-3); margin-top: 2px; }
    .config-ctrl  { flex-shrink: 0; }
    input[type="number"] { width: 70px; text-align: center; }
    input[type="text"].cron { width: 150px; font-family: var(--mono); font-size: 12px; }
    .mode-toggle { display: flex; border-radius: var(--radius-sm); overflow: hidden; border: 1px solid var(--border); }
    .mode-btn { padding: 5px 12px; font-size: 11px; font-weight: 600; font-family: var(--mono); cursor: pointer; background: transparent; color: var(--text-3); letter-spacing: .5px; border: none; transition: all var(--transition); }
    .mode-btn.active-dry  { background: var(--warn-bg);    color: var(--warn); }
    .mode-btn.active-live { background: var(--success-bg); color: var(--success); }
    .toggle { position: relative; width: 36px; height: 20px; cursor: pointer; display: block; }
    .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
    .toggle-track { position: absolute; top:0;left:0;right:0;bottom:0; background: var(--border); border-radius: 99px; transition: background var(--transition); }
    .toggle input:checked ~ .toggle-track { background: var(--accent); }
    .toggle-thumb { position: absolute; top:3px;left:3px; width:14px;height:14px; background:#fff; border-radius:50%; transition:transform var(--transition); box-shadow:0 1px 3px rgba(0,0,0,.4); }
    .toggle input:checked ~ .toggle-track .toggle-thumb { transform: translateX(16px); }

    /* ‚îÄ‚îÄ Health view ‚îÄ‚îÄ */
    .health-list { display: flex; flex-direction: column; gap: 8px; }
    .health-item { background: var(--surface); border: 1px solid var(--border-subtle); border-radius: var(--radius); padding: 14px 16px; display: flex; align-items: flex-start; gap: 12px; }
    .health-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
    .health-name { font-size: 13px; font-weight: 600; }
    .health-detail { font-size: 12px; color: var(--text-2); margin-top: 2px; }
    .health-fix { font-family: var(--mono); font-size: 11px; color: var(--accent-hi); margin-top: 6px; background: var(--accent-glow); padding: 3px 8px; border-radius: 4px; display: inline-block; }

    /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.72); backdrop-filter: blur(5px);
      display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px;
      opacity: 0; pointer-events: none; transition: opacity .2s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
      width: 100%; max-width: 640px; max-height: 90vh; overflow-y: auto;
      transform: translateY(12px); transition: transform .2s;
    }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal-head {
      padding: 18px 20px 14px; display: flex; align-items: flex-start; justify-content: space-between;
      border-bottom: 1px solid var(--border-subtle);
      position: sticky; top: 0; background: var(--surface); z-index: 1;
    }
    .modal-title { font-size: 15px; font-weight: 600; }
    .modal-id    { font-family: var(--mono); font-size: 11px; color: var(--text-3); margin-top: 3px; }
    .modal-close { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-3); font-size: 16px; background: transparent; border: none; transition: all var(--transition); flex-shrink: 0; }
    .modal-close:hover { background: var(--surface-hi); color: var(--text); }
    .modal-body { padding: 20px; }
    .modal-video { margin-bottom: 20px; background: #000; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: center; }
    .modal-video video { max-height: 300px; max-width: 100%; display: block; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .detail-item.full { grid-column: 1/-1; }
    .detail-key { font-size: 11px; color: var(--text-3); font-weight: 500; text-transform: uppercase; letter-spacing: .4px; margin-bottom: 3px; }
    .detail-val { font-size: 12px; color: var(--text); word-break: break-all; font-family: var(--mono); }
    .detail-val.error { color: var(--danger); }
    .rh-title { font-size: 12px; font-weight: 600; color: var(--text-2); margin-bottom: 10px; }
    .rh-item { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-top: 1px solid var(--border-subtle); }
    .rh-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--border); flex-shrink: 0; margin-top: 5px; }
    .rh-dot.ok  { background: var(--success); }
    .rh-dot.err { background: var(--danger); }
    .rh-states { font-size: 12.5px; font-family: var(--mono); }
    .rh-provider { font-size: 11px; color: var(--text-3); margin-left: 6px; }
    .rh-time { font-size: 11px; color: var(--text-3); margin-top: 2px; }
    .rh-err  { font-size: 11.5px; color: var(--danger); margin-top: 3px; }
    .modal-actions { padding: 14px 20px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: flex-end; gap: 8px; }

    /* ‚îÄ‚îÄ Toasts ‚îÄ‚îÄ */
    .toast-rack { position: fixed; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 8px; z-index: 200; pointer-events: none; }
    .toast {
      display: flex; align-items: center; gap: 10px; padding: 11px 16px; border-radius: var(--radius);
      font-size: 13px; font-weight: 500; min-width: 240px; pointer-events: all;
      animation: toast-in .25s ease; box-shadow: 0 4px 24px rgba(0,0,0,.45);
    }
    @keyframes toast-in { from { opacity:0; transform:translateY(10px) scale(.97); } to { opacity:1; transform:none; } }
    .toast-success { background: var(--success-bg); color: var(--success); border: 1px solid rgba(34,197,94,.2); }
    .toast-error   { background: var(--danger-bg);  color: var(--danger);  border: 1px solid rgba(239,68,68,.2); }

    /* ‚îÄ‚îÄ Misc ‚îÄ‚îÄ */
    .divider { height: 1px; background: var(--border-subtle); margin: 16px 0; }
    .mono { font-family: var(--mono); }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
  </style>
</head>
<body>
<div class="shell">

  <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ -->
  <aside class="sidebar">
    <div class="sb-logo">
      <div class="sb-logo-mark">N</div>
      <div class="sb-logo-text">nator<span>V2</span></div>
    </div>
    <nav class="sb-nav">
      <div class="nav-item active" onclick="go('pipeline')" data-view="pipeline">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="2" y="2" width="5" height="5" rx="1"/><rect x="9" y="2" width="5" height="5" rx="1"/>
          <rect x="2" y="9" width="5" height="5" rx="1"/><rect x="9" y="9" width="5" height="5" rx="1"/>
        </svg>Pipeline
      </div>
      <div class="nav-item" onclick="go('clips')" data-view="clips">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="2" y="3" width="12" height="10" rx="1.5"/>
          <path d="M6.5 6l4 2-4 2V6z" fill="currentColor" stroke="none"/>
        </svg>Clips
      </div>
      <div class="nav-item" onclick="go('jobs')" data-view="jobs">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M3 4h10M3 8h10M3 12h6"/>
        </svg>Jobs
      </div>
      <div class="nav-item" onclick="go('settings')" data-view="settings">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="8" cy="8" r="2.5"/>
          <path d="M8 1.5v2M8 12.5v2M1.5 8h2M12.5 8h2M3.4 3.4l1.4 1.4M11.2 11.2l1.4 1.4M3.4 12.6l1.4-1.4M11.2 4.8l1.4-1.4"/>
        </svg>Settings
      </div>
      <div class="nav-item" onclick="go('health')" data-view="health">
        <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M1.5 8h3l2-4.5 2 9 2-4.5h3"/>
        </svg>Health
      </div>
    </nav>
    <div class="sb-footer">
      <div id="modeChip" class="mode-chip dry">DRY</div>
    </div>
  </aside>

  <!-- ‚îÄ‚îÄ Main ‚îÄ‚îÄ -->
  <main class="main">

    <!-- VIEW: Pipeline -->
    <div id="view-pipeline" class="view active">
      <div class="view-header">
        <div class="view-title">Pipeline</div>
        <div class="view-sub">Create a post, start the assembly line</div>
      </div>
      <div class="pipeline-grid">

        <!-- New Post -->
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">New Post</div>
              <div class="card-sub">Configure and launch</div>
            </div>
          </div>
          <div class="card-body">
            <div class="field">
              <label class="lbl" for="clipSelect">Clip</label>
              <select id="clipSelect">
                <option value="">‚ö° Auto-pick next available</option>
              </select>
            </div>
            <div class="field">
              <label class="lbl" for="scriptInput">Voice-over Script</label>
              <textarea id="scriptInput" rows="9" placeholder="Paste your script here. This text will be converted to speech and synced with your video clip.

Tip: Generate a script in Claude.ai or ChatGPT, then paste it here."></textarea>
            </div>
            <button class="btn btn-primary btn-full" id="btnStart" onclick="startPipeline()">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><path d="M2 1.5l8 4.5-8 4.5V1.5z"/></svg>
              Start Pipeline
            </button>
            <div class="stats-bar">
              <div class="stat-item">Today <span id="statToday" class="stat-val">‚Äì</span></div>
              <div class="stat-item">Mode <span id="statMode" class="stat-val">‚Äì</span></div>
              <div class="stat-item">Clips <span id="statClips" class="stat-val">‚Äì</span></div>
            </div>
          </div>
        </div>

        <!-- Right column -->
        <div>
          <!-- Active job stepper -->
          <div class="card active-job-card hidden" id="activeJobCard">
            <div class="card-head">
              <div>
                <div class="card-title">Running Now</div>
                <div id="activeJobMeta" class="card-sub mono">‚Äì</div>
              </div>
              <div id="activeJobBadge"></div>
            </div>
            <div class="card-body">
              <div class="stepper" id="stepper"></div>
            </div>
          </div>

          <!-- Recent posts -->
          <div class="card">
            <div class="card-head"><div class="card-title">Recent Posts</div></div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>State</th><th>Caption</th><th>Age</th></tr></thead>
                <tbody id="recentJobsTbody">
                  <tr class="tbody-empty"><td colspan="3">No posts yet ‚Äî start your first pipeline run</td></tr>
                </tbody>
              </table>
            </div>
            <div class="table-footer"><a onclick="go('jobs')">View all jobs ‚Üí</a></div>
          </div>
        </div>

      </div>
    </div>

    <!-- VIEW: Clips -->
    <div id="view-clips" class="view">
      <div class="view-header">
        <div class="view-title">Clips</div>
        <div class="view-sub">Source video files for your posts</div>
      </div>
      <div class="dropzone" id="dropzone" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept="video/*" multiple style="display:none" onchange="handleFiles(this.files)">
        <div class="dz-icon">‚¨Ü</div>
        <div class="dz-text">Drop .mp4 files here or click to browse</div>
        <div class="dz-hint">Vertical 9:16 clips work best for Instagram Reels</div>
      </div>
      <div class="clips-grid" id="clipsGrid">
        <div class="clips-empty">
          <div class="clips-empty-icon">üé¨</div>
          <div>No clips yet ‚Äî drop one above ‚Üë</div>
        </div>
      </div>
    </div>

    <!-- VIEW: Jobs -->
    <div id="view-jobs" class="view">
      <div class="view-header">
        <div class="view-title">Jobs</div>
        <div class="view-sub">Full pipeline run history</div>
      </div>
      <div class="filter-tabs">
        <div class="tab active" data-s="" onclick="setJobFilter('')">All</div>
        <div class="tab" data-s="pending"  onclick="setJobFilter('pending')">Pending</div>
        <div class="tab" data-s="done"     onclick="setJobFilter('done')">Done</div>
        <div class="tab" data-s="failed"   onclick="setJobFilter('failed')">Failed</div>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Job ID</th><th>State</th><th>Caption</th><th>Age</th><th></th></tr></thead>
            <tbody id="jobsTbody">
              <tr class="tbody-empty"><td colspan="5">No jobs yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- VIEW: Settings -->
    <div id="view-settings" class="view">
      <div class="view-header">
        <div class="view-title">Settings</div>
        <div class="view-sub">Provider configuration and pipeline options</div>
      </div>
      <div class="settings-grid">
        <div class="card">
          <div class="card-head"><div class="card-title">Providers</div></div>
          <div class="card-body" id="providersCard" style="padding-top:4px;padding-bottom:4px;">
            <div style="color:var(--text-3);font-size:12px;padding:12px 0;">Loading‚Ä¶</div>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><div class="card-title">Pipeline Config</div></div>
          <div class="card-body" style="padding-top:6px;padding-bottom:6px;">
            <div class="config-row">
              <div><div class="config-label">Publish Mode</div><div class="config-key">pipeline.publish_mode</div></div>
              <div class="config-ctrl">
                <div class="mode-toggle">
                  <button class="mode-btn" id="btnDry"  onclick="setMode('dry')">DRY</button>
                  <button class="mode-btn" id="btnLive" onclick="setMode('live')">LIVE</button>
                </div>
              </div>
            </div>
            <div class="config-row">
              <div><div class="config-label">Max Posts / Day</div><div class="config-key">pipeline.max_posts_per_day</div></div>
              <div class="config-ctrl"><input type="number" id="cfgMaxPosts" min="1" max="25" value="3" onchange="saveConfig('pipeline.max_posts_per_day',this.value)"></div>
            </div>
            <div class="config-row">
              <div><div class="config-label">Scheduler</div><div class="config-key">scheduler.enabled</div></div>
              <div class="config-ctrl">
                <label class="toggle">
                  <input type="checkbox" id="cfgScheduler" onchange="saveConfig('scheduler.enabled',this.checked?'true':'false')">
                  <div class="toggle-track"><div class="toggle-thumb"></div></div>
                </label>
              </div>
            </div>
            <div class="config-row">
              <div><div class="config-label">Cron Expression</div><div class="config-key">scheduler.cron</div></div>
              <div class="config-ctrl"><input type="text" class="cron" id="cfgCron" placeholder="0 9-11 * * 1-5" onchange="saveConfig('scheduler.cron',this.value)"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: Health -->
    <div id="view-health" class="view">
      <div class="view-header view-header-row">
        <div>
          <div class="view-title">Health</div>
          <div class="view-sub">System diagnostics and configuration checks</div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="loadHealth()">‚Ü∫ Refresh</button>
      </div>
      <div class="health-list" id="healthList">
        <div style="color:var(--text-3);font-size:13px;">Running checks‚Ä¶</div>
      </div>
    </div>

  </main>
</div>

<!-- ‚îÄ‚îÄ Modal ‚îÄ‚îÄ -->
<div class="modal-overlay" id="modalOverlay" onclick="handleOverlayClick(event)">
  <div class="modal" id="modal">
    <div class="modal-head">
      <div>
        <div class="modal-title" id="modalTitle">Job Details</div>
        <div class="modal-id" id="modalId">‚Äì</div>
      </div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body"  id="modalBody"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Toasts ‚îÄ‚îÄ -->
<div class="toast-rack" id="toastRack"></div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  view: 'pipeline',
  status: null,
  allJobs: [],
  clips: [],
  providers: null,
  config: {},
  health: [],
  activeJob: null,
  jobStartTime: null,
  refreshTimer: null,
  jobFilter: '',
};

const STEPS       = ['scripting','tts','rendering','uploading','publishing'];
const STEP_LABELS = ['Script','TTS','Render','Upload','Publish'];
const ACTIVE_SET  = new Set(STEPS);

// ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function go(view) {
  S.view = view;
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const vEl = document.getElementById(`view-${view}`);
  if (vEl) vEl.classList.add('active');
  const nEl = document.querySelector(`.nav-item[data-view="${view}"]`);
  if (nEl) nEl.classList.add('active');
  if (view === 'settings') loadSettings();
  if (view === 'health')   loadHealth();
  if (view === 'jobs')     renderJobsView();
  if (view === 'clips')    renderClipsView();
}

// ‚îÄ‚îÄ‚îÄ Refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refresh() {
  try {
    const [sr, jr, cr] = await Promise.all([
      fetch('/api/status'),
      fetch('/api/jobs?limit=100'),
      fetch('/api/clips?limit=100'),
    ]);
    S.status  = await sr.json();
    S.allJobs = await jr.json();
    S.clips   = await cr.json();
  } catch(e) { console.warn('[refresh]', e.message); }

  // Track active job
  const active = S.allJobs.find(j => ACTIVE_SET.has(j.state));
  if (active && S.activeJob?.id !== active.id) {
    S.activeJob = active; S.jobStartTime = Date.now();
  } else if (!active) {
    S.activeJob = null;
  } else if (active) {
    S.activeJob = active;
  }

  // Adaptive refresh rate
  const want = active ? 2000 : 5000;
  if (S.refreshTimer && S.refreshTimer._iv !== want) {
    clearInterval(S.refreshTimer);
    S.refreshTimer = setInterval(refresh, want);
    S.refreshTimer._iv = want;
  }

  renderAll();
}

// ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
  renderModeChip();
  renderStatsBar();
  renderClipSelect();
  renderStepper();
  renderRecentJobs();
  if (S.view === 'jobs')  renderJobsView();
  if (S.view === 'clips') renderClipsView();
}

function renderModeChip() {
  const c = document.getElementById('modeChip');
  const m = S.status?.publishMode || 'dry';
  c.className = `mode-chip ${m}`;
  c.textContent = m.toUpperCase();
}

function renderStatsBar() {
  const s = S.status;
  if (!s) return;
  qs('#statToday').textContent = `${s.todayPosts}/${s.maxPostsPerDay}`;
  qs('#statMode').textContent  = (s.publishMode||'dry').toUpperCase();
  qs('#statClips').textContent = `${s.clips?.available||0} available`;
}

function renderClipSelect() {
  const sel = qs('#clipSelect');
  const cur = sel.value;
  while (sel.options.length > 1) sel.remove(1);
  S.clips.filter(c => c.status === 'available').forEach(c => {
    sel.add(new Option(fname(c.file_path || c.id), c.id));
  });
  if (cur) sel.value = cur;
}

function renderStepper() {
  const card = qs('#activeJobCard');
  const job  = S.activeJob;
  if (!job) { card.classList.add('hidden'); return; }
  card.classList.remove('hidden');
  const idx     = STEPS.indexOf(job.state);
  const elapsed = S.jobStartTime ? Math.round((Date.now()-S.jobStartTime)/1000) : 0;
  qs('#activeJobMeta').textContent = `${sid(job.id)} ¬∑ ${elapsed}s elapsed`;
  qs('#activeJobBadge').innerHTML  = badge(job.state);
  qs('#stepper').innerHTML = STEPS.map((s,i) => {
    const cls = i < idx ? 'step done' : i === idx ? 'step active' : 'step';
    const dot = i < idx ? '‚úì' : i+1;
    return `<div class="${cls}"><div class="step-dot">${dot}</div><div class="step-label">${STEP_LABELS[i]}</div></div>`;
  }).join('');
}

function renderRecentJobs() {
  const tb = qs('#recentJobsTbody');
  const jobs = S.allJobs.slice(0, 8);
  if (!jobs.length) {
    tb.innerHTML = '<tr class="tbody-empty"><td colspan="3">No posts yet ‚Äî start your first pipeline run</td></tr>';
    return;
  }
  tb.innerHTML = jobs.map(j => `
    <tr onclick="openJobModal('${j.id}')">
      <td>${badge(j.state)}</td>
      <td style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:${j.caption?'var(--text)':'var(--text-3)'}">
        ${esc(j.caption ? j.caption.slice(0,80) : '‚Äî')}
      </td>
      <td style="color:var(--text-2);white-space:nowrap;font-size:12px;">${ago(j.updated_at||j.created_at)}</td>
    </tr>`).join('');
}

function renderJobsView() {
  const tb = qs('#jobsTbody');
  let jobs = S.allJobs;
  if (S.jobFilter) jobs = jobs.filter(j => j.state === S.jobFilter);
  if (!jobs.length) {
    tb.innerHTML = `<tr class="tbody-empty"><td colspan="5">${S.jobFilter?`No ${S.jobFilter} jobs`:'No jobs yet'}</td></tr>`;
    return;
  }
  tb.innerHTML = jobs.map(j => `
    <tr onclick="openJobModal('${j.id}')">
      <td><span class="mono" style="font-size:11px;color:var(--text-2)">${sid(j.id)}</span></td>
      <td>${badge(j.state)}</td>
      <td style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:${j.caption?'var(--text)':'var(--text-3)'}">
        ${esc(j.caption ? j.caption.slice(0,60) : '‚Äî')}
      </td>
      <td style="color:var(--text-2);white-space:nowrap;font-size:12px;">${ago(j.updated_at||j.created_at)}</td>
      <td>${j.state==='failed'?`<button class="btn btn-danger btn-sm" onclick="event.stopPropagation();doRetry('${j.id}')">‚Ü∫ Retry</button>`:''}</td>
    </tr>`).join('');
}

function renderClipsView() {
  const grid = qs('#clipsGrid');
  if (!S.clips.length) {
    grid.innerHTML = '<div class="clips-empty"><div class="clips-empty-icon">üé¨</div><div>No clips yet ‚Äî drop one above ‚Üë</div></div>';
    return;
  }
  grid.innerHTML = S.clips.map(c => `
    <div class="clip-card" id="clip-${c.id}" onclick="toggleClip('${c.id}')">
      <div class="clip-card-body">
        <div class="clip-name">${esc(fname(c.file_path||c.id))}</div>
        <div class="clip-meta">${badge(c.status)}<span class="clip-size">${fmtb(c.file_size||0)}</span></div>
        <div style="font-size:11px;color:var(--text-3);margin-top:5px;">${ago(c.ingested_at||c.created_at)}</div>
      </div>
    </div>`).join('');
}

function toggleClip(id) {
  const card = qs(`#clip-${id}`);
  card.classList.toggle('expanded');
  const vid = card.querySelector('video');
  if (vid) { vid.remove(); return; }
  const v = document.createElement('video');
  v.src = `/api/clips/${id}/preview`;
  v.controls = true;
  v.style.cssText = 'width:100%;display:block;background:#000;max-height:200px;object-fit:contain;';
  card.prepend(v);
}

// ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadSettings() {
  const [pr, cr] = await Promise.all([fetch('/api/providers'), fetch('/api/config')]);
  S.providers = await pr.json();
  S.config    = await cr.json();
  renderProviders();
  renderConfigInputs();
}

function renderProviders() {
  const p = S.providers;
  if (!p) return;
  qs('#providersCard').innerHTML = Object.keys(p.available).map(type => {
    const active = p.active[type] || 'mock';
    const pills  = p.available[type].map(o =>
      `<span class="provider-pill ${o===active?'active':''}" onclick="setProvider('${type}','${o}')">${o}</span>`
    ).join('');
    return `<div class="provider-row"><div class="provider-type">${type}</div><div class="provider-pills">${pills}</div></div>`;
  }).join('');
}

function renderConfigInputs() {
  const c = S.config;
  const mode = c['pipeline.publish_mode'] || 'dry';
  qs('#btnDry').className  = `mode-btn ${mode==='dry'  ? 'active-dry'  : ''}`;
  qs('#btnLive').className = `mode-btn ${mode==='live' ? 'active-live' : ''}`;
  const mp = qs('#cfgMaxPosts'); if (mp) mp.value = c['pipeline.max_posts_per_day'] || '3';
  const sc = qs('#cfgScheduler'); if (sc) sc.checked = c['scheduler.enabled']==='true';
  const cr = qs('#cfgCron'); if (cr) cr.value = c['scheduler.cron'] || '0 9-11 * * 1-5';
}

async function setProvider(type, name) {
  await saveConfig(`provider.${type}`, name);
  await loadSettings();
  toast(`${type} ‚Üí ${name}`);
}

function setMode(mode) {
  saveConfig('pipeline.publish_mode', mode);
  qs('#btnDry').className  = `mode-btn ${mode==='dry'  ? 'active-dry'  : ''}`;
  qs('#btnLive').className = `mode-btn ${mode==='live' ? 'active-live' : ''}`;
  if (S.status) S.status.publishMode = mode;
  renderModeChip(); renderStatsBar();
  toast(`Publish mode: ${mode.toUpperCase()}`);
}

async function saveConfig(key, value) {
  try { await fetch('/api/config', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({key,value}) }); }
  catch(e) { toast('Save failed', 'error'); }
}

// ‚îÄ‚îÄ‚îÄ Health ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadHealth() {
  qs('#healthList').innerHTML = '<div style="color:var(--text-3);font-size:13px;">Running checks‚Ä¶</div>';
  try { const r = await fetch('/api/doctor'); S.health = await r.json(); }
  catch { S.health = []; }
  if (!S.health.length) { qs('#healthList').innerHTML = '<div style="color:var(--text-3)">No checks returned</div>'; return; }
  qs('#healthList').innerHTML = S.health.map(h => {
    const icon = h.ok ? '‚úÖ' : h.warning ? '‚ö†Ô∏è' : '‚ùå';
    const fix  = (!h.ok && h.fix) ? `<div class="health-fix">${esc(h.fix)}</div>` : '';
    return `<div class="health-item">
      <div class="health-icon">${icon}</div>
      <div>
        <div class="health-name">${esc(h.name)}</div>
        <div class="health-detail">${esc(h.detail||'')}</div>${fix}
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ Pipeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startPipeline() {
  const clipId     = qs('#clipSelect').value || null;
  const scriptText = qs('#scriptInput').value.trim() || null;
  const btn = qs('#btnStart');
  btn.disabled = true;
  btn.textContent = 'Starting‚Ä¶';
  try {
    const r = await fetch('/api/run', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({clipId, scriptText}) });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error||'Failed');
    toast(`Pipeline started ¬∑ ${sid(d.jobId)}`);
    qs('#scriptInput').value = '';
    qs('#clipSelect').value  = '';
    setTimeout(refresh, 400);
  } catch(e) {
    toast(e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><path d="M2 1.5l8 4.5-8 4.5V1.5z"/></svg> Start Pipeline';
  }
}

async function doRetry(id) {
  try {
    const r = await fetch(`/api/jobs/${id}/retry`, {method:'POST'});
    const d = await r.json();
    if (!r.ok) throw new Error(d.error);
    toast(`Retrying ${sid(id)}`);
    setTimeout(refresh, 400);
  } catch(e) { toast(e.message,'error'); }
}

// ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openJobModal(id) {
  const overlay = qs('#modalOverlay');
  overlay.classList.add('open');
  qs('#modalTitle').textContent = 'Job Details';
  qs('#modalId').textContent    = id;
  qs('#modalBody').innerHTML    = '<div style="color:var(--text-3);padding:20px 0;font-size:13px;">Loading‚Ä¶</div>';
  qs('#modalActions').innerHTML = '';

  try {
    const job = await fetch(`/api/jobs/${id}`).then(r => r.json());
    let html = '';

    if (job.rendered_video_path) {
      html += `<div class="modal-video"><video src="/api/jobs/${id}/video" controls preload="metadata"></video></div>`;
    }

    const fields = [
      ['ID',         job.id,                     true ],
      ['State',      badge(job.state),            false],
      ['Created',    fmtd(job.created_at),        false],
      ['Updated',    fmtd(job.updated_at),        false],
      ['Last Good',  job.last_good_state || '‚Äî',  false],
      ['IG Media',   job.ig_media_id    || '‚Äî',   false],
    ];
    if (job.caption)       fields.push(['Caption',    job.caption,         true ]);
    if (job.upload_url)    fields.push(['Upload URL',  job.upload_url,      true ]);
    if (job.error_message) fields.push(['Error', `<span class="error">${esc(job.error_message)}</span>`, true]);

    html += '<div class="detail-grid">';
    for (const [k,v,full] of fields) {
      const display = typeof v === 'string' && !v.startsWith('<') ? esc(v) : v;
      html += `<div class="detail-item${full?' full':''}"><div class="detail-key">${k}</div><div class="detail-val">${display}</div></div>`;
    }
    html += '</div>';

    if (job.runs?.length) {
      html += `<div class="rh-title">Run History ‚Äî ${job.runs.length} transition${job.runs.length!==1?'s':''}</div>`;
      html += job.runs.map(r => `
        <div class="rh-item">
          <div class="rh-dot ${r.error?'err':'ok'}"></div>
          <div>
            <div class="rh-states">${esc(r.state_from)} <span style="color:var(--text-3)">‚Üí</span> ${esc(r.state_to)}${r.provider?` <span class="rh-provider">[${esc(r.provider)}]</span>`:''}</div>
            <div class="rh-time">${fmtd(r.created_at)}</div>
            ${r.error?`<div class="rh-err">‚Ü≥ ${esc(r.error)}</div>`:''}
          </div>
        </div>`).join('');
    }

    qs('#modalBody').innerHTML = html;
    if (job.state === 'failed') {
      qs('#modalActions').innerHTML = `<button class="btn btn-danger" onclick="doRetry('${job.id}');closeModal()">‚Ü∫ Retry this job</button>`;
    }
  } catch(e) {
    qs('#modalBody').innerHTML = `<div style="color:var(--danger);padding:12px 0;">${esc(e.message)}</div>`;
  }
}

function handleOverlayClick(e) { if (e.target === qs('#modalOverlay')) closeModal(); }
function closeModal() { qs('#modalOverlay').classList.remove('open'); }

// ‚îÄ‚îÄ‚îÄ File upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function handleFiles(files) {
  for (const f of files) {
    if (!f.type.startsWith('video/')) { toast(`Not a video: ${f.name}`, 'error'); continue; }
    const fd = new FormData();
    fd.append('clip', f);
    try {
      const r = await fetch('/api/clips/ingest', {method:'POST', body:fd});
      const d = await r.json();
      if (!r.ok) throw new Error(d.error);
      toast(`Ingested: ${fname(d.file_path||f.name)}`);
      await refresh();
    } catch(e) { toast(e.message,'error'); }
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const dz = qs('#dropzone');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
  dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
});

// ‚îÄ‚îÄ‚îÄ Jobs filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setJobFilter(s) {
  S.jobFilter = s;
  document.querySelectorAll('.filter-tabs .tab').forEach(t => t.classList.toggle('active', t.dataset.s === s));
  renderJobsView();
}

// ‚îÄ‚îÄ‚îÄ Toasts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type='success') {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = (type==='success' ? '‚úì  ' : '‚úï  ') + msg;
  qs('#toastRack').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const qs = sel => document.querySelector(sel);

function badge(s) {
  const l = s || 'unknown';
  return `<span class="badge badge-${l}">${l}</span>`;
}

function ago(ds) {
  if (!ds) return '‚Äì';
  const secs = Math.floor((Date.now() - new Date(ds + (ds.endsWith('Z')?'':' UTC'))) / 1000);
  if (secs < 60)    return 'just now';
  if (secs < 3600)  return `${Math.floor(secs/60)}m ago`;
  if (secs < 86400) return `${Math.floor(secs/3600)}h ago`;
  return `${Math.floor(secs/86400)}d ago`;
}

function fmtd(ds) {
  if (!ds) return '‚Äî';
  try { return new Date(ds + (ds.endsWith('Z')?'':' UTC')).toLocaleString(); } catch { return ds; }
}

function fmtb(b) {
  if (!b) return '0 B';
  if (b < 1024)    return `${b} B`;
  if (b < 1048576) return `${(b/1024).toFixed(1)} KB`;
  return `${(b/1048576).toFixed(1)} MB`;
}

function sid(id) {
  if (!id) return '‚Äì';
  return id.length > 26 ? id.slice(0,26)+'‚Ä¶' : id;
}

function fname(p) {
  if (!p) return '‚Äì';
  return p.split(/[\\/]/).pop();
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
refresh();
S.refreshTimer = setInterval(refresh, 5000);
S.refreshTimer._iv = 5000;
</script>
</body>
</html>
